
# 智能盆栽系统通信协议（简化版）

## 一、概述

本协议用于 **STM32、ESP-01S 与网页** 之间的数据交互。
采用 **JSON 文本格式**，每条消息以换行符 `\n` 结尾（NDJSON 方式）。
通信方向：

```
网页 ⇄ ESP-01S ⇄ STM32
```

---

## 二、消息类型

| 类型       | 方向               | 功能            |
| -------- | ---------------- | ------------- |
| `data`   | STM32 → ESP → 网页 | 上传环境数据        |
| `cmd`    | 网页 → ESP → STM32 | 控制继电器动作       |
| `ack`    | STM32 → ESP → 网页 | 执行结果反馈        |
| `status` | ESP → STM32      | 报告网络状态与 IP 地址 |

---

## 三、消息格式

### 1. 环境数据上报（`type: data`）

```json
{
  "type": "data",
  "temp": 25.3,
  "humi": 61.2,
  "soil": 48,
  "lux": 345.6,
  "water": 0,
  "light": 1,
  "fan": 0
}
```

| 字段      | 含义             |
| ------- | -------------- |
| `temp`  | 温度 (℃)         |
| `humi`  | 湿度 (%)         |
| `soil`  | 土壤湿度 (%)       |
| `lux`   | 光照强度 (lx)      |
| `water` | 水泵状态（0关 / 1开）  |
| `light` | 补光灯状态（0关 / 1开） |
| `fan`   | 风扇状态（0关 / 1开）  |

---

### 2. 控制命令（`type: cmd`）

```json
{
  "type": "cmd",
  "target": "water",
  "action": "pulse",
  "time": 2000
}
```

| 字段       | 含义                                 |
| -------- | ---------------------------------- |
| `target` | 控制对象：`"water"`, `"light"`, `"fan"` |
| `action` | 动作类型：`"on"`、`"off"`、`"pulse"`      |
| `time`   | 脉冲持续时间（ms，仅 pulse 模式使用）            |

示例：

* 开灯 → `{"type":"cmd","target":"light","action":"on"}`
* 补水 2 秒 → `{"type":"cmd","target":"water","action":"pulse","time":2000}`

---

### 3. 执行回执（`type: ack`）

```json
{
  "type": "ack",
  "target": "water",
  "action": "pulse",
  "result": "ok"
}
```

| 字段       | 含义                         |
| -------- | -------------------------- |
| `target` | 被执行的对象                     |
| `action` | 执行动作                       |
| `result` | `"ok"` 表示成功，`"error"` 表示失败 |

---

### 4. 网络状态（`type: status`）

```json
{
  "type": "status",
  "ip": "192.168.4.1"
}
```

| 字段          | 含义                 |
| ----------- | ------------------ |
| `ip`        | 当前 ESP-01S 的 IP 地址 |
| `"0.0.0.0"` | 表示网络连接失败或通信异常      |

STM32 在屏幕上显示：

* 若 IP 为 `"0.0.0.0"` → 显示“网络未连接”
* 否则显示 “访问地址：192.168.x.x”

---

## 四、通信流程

```
1. ESP 启动后发送  { "type":"status", "ip":"192.168.x.x" }
   → STM32 显示 IP。

2. STM32 定期发送  { "type":"data", ... }
   → ESP 转发给网页实时显示。

3. 网页点击按钮发送  { "type":"cmd", ... }
   → ESP 转发给 STM32 执行。

4. STM32 执行后返回  { "type":"ack", ... }
   → ESP 转发给网页显示执行结果。
```

---

## 五、约定

* 所有 JSON 以一行发送，结尾 `\n`。
* 通信失败或 Wi-Fi 未连接时，ESP 发送：

  ```json
  {"type":"status","ip":"0.0.0.0"}
  ```
* STM32 屏幕仅解析 `type` 和 `ip` 字段以显示状态。

---

**总结：**
此简化协议以 `type` 字段区分消息类型，结构直观、解析简单，
同时通过 `ip` 字段实现 ESP 网络信息回传，方便 STM32 端屏幕显示网页访问地址。
